# 2022/12/07

## L4 로드밸런싱

![](https://velog.velcdn.com/images/ririti/post/f1ab5f74-29cf-435a-b81a-a76e772072da/image.png)


>IP 주소와 포트를 기반으로 로드밸런싱하는 고가의 하드웨어로, 웬만한 서비스에서는 이것만으로도 부하 분산을 처리하기에 충분하다.

- L4는 VIP(virtual IP) 단위로만 로드밸런싱하기 때문에 반드시 하나의 VIP에 연결된 서버의 수가 비슷해야 한다.
    - 서버 중 몇 대에 문제가 생긴다면 동일한 VIP에 연결된 다른 서버 역시 연달아 부하가 발생하여 더욱 심각한 문제가 발생할 수 있다.

- L4의 스펙상 최대 세션 수는 존재하나 세션을 맺는 시나리오에 따라 최대 성능이 다르다.
    - 최대 세션 용량에 도달하지 않았어도 추가로 세션을 연결할 수 없는 문제가 발생하기도 한다.

- 통신사 장애 등으로 세션이 비정상적으로 종료된 경우 세션 서버에서는 클라이언트와 세션이 종료되고 정상적으로 다시 연결되었지만, L4에서는 세션 종료처리가 제대로 되지 않아 두 개의 세션을 동시에 유지하고 있어 L4의 한계 용량을 초과할 수도 있다.


## L7 로드밸런싱
![](https://velog.velcdn.com/images/ririti/post/d9d0f07b-4197-4ab5-aab3-01e28c51b5f8/image.png)

> 애플리케이션 계층에서 분산하기 때문에 HTTP헤더, 쿠키등의 정보를 통해 정교하게 로드밸런싱이 가능하다.

DDoS와 같은 비정상적인 트래픽을 필터링이 가능하다.


**1. URL 스위칭 방식**
- URL 주소에서 문자영 기준으로 부하를 분산하는 방식

**2. 쿠키 방식**
- HTTP 헤더의 쿠키값 설정에 따라 분산하는 방식

**3. Content 스위칭**
- 애매해서 좀더 찾아보고 정리



## 오픈 소스 로드 밸런서 HAProxy

>하드웨어 스위치를 대체하는 소프트웨어 로드 밸런서로, 네트워크 스위치에서 제공하는 L4, L7 기능 및 로드 밸런서 기능을 제공

![](https://velog.velcdn.com/images/ririti/post/26c83599-b134-425c-9550-11cd71355b33/image.png)

### 동작방식
1. 최초 접근 시 서버에 요청 전달

2. 응답 시 쿠키(cookie)에 서버 정보 추가 후 반환

3. 재요청 시 proxy에서 쿠키 정보 확인 > 최초 요청 서버로 전달

4. 다시 접근 시 쿠키 추가 없이 전달 > 클라이언트에 쿠키 정보가 계속 존재함(쿠키 재사용)